// t3d-pano
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("t3d")):"function"==typeof define&&define.amd?define(["exports","t3d"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).t3d=t.t3d||{},t.t3d)}(this,(function(t,e){"use strict";class n extends e.Mesh{constructor(t={}){const n=new e.SphereGeometry(t.radius||10,60,40),o=new e.ShaderMaterial(i);o.transparent=!0,o.depthTest=!1,o.depthWrite=!1,o.side=e.DRAW_SIDE.BACK,super(n,o),this.renderOrder=-999}}n.prototype.isPano=!0;const i={defines:{},uniforms:{stretchFactor:0,stretchDirection:[0,0,1]},vertexShader:"\n\t\t\t\t#include <common_vert>\n\n\t\t\t\tattribute vec2 a_Uv;\n\t\t\t\tvarying vec2 v_Uv;\n\t\t\t\t\n\t\t\t\tvoid main() {\n\t\t\t\t\t\tv_Uv = a_Uv;\n\t\t\tvec4 worldPosition = u_Model * vec4(a_Position, 1.0);\n\t\t\tworldPosition.xyz += u_CameraPosition;\n\t\t\t\t\t\tgl_Position = u_ProjectionView * worldPosition;\n\t\t\tgl_Position.z = gl_Position.w;\n\t\t\t\t}\n\t\t",fragmentShader:"\n\t\t\t\tuniform float stretchFactor;\n\t\tuniform vec3 stretchDirection;\n\n\t\t\t\tuniform sampler2D diffuseMap;\n\t\t\t\tuniform float u_Opacity;\n\t\tuniform vec3 u_Color;\n\t\tuniform mat4 u_Model;\n\n\t\tvarying vec2 v_Uv;\n\n\t\t// spherical coordinates:\n\t\t// phi: lateral angle, start from -x axis, [0-2PI]\n\t\t// theta: lateral angle, start from +y axis, [0-PI]\n\n\t\t// uv -> spherical -> vector3\n\t\tvoid uvToVector3(in vec2 uv, out vec3 vector) {\n\t\t\tfloat phi = uv.x * 2. * PI;\n\t\t\tfloat theta = -uv.y * PI;\n\n\t\t\tvector.x = -cos(phi) * sin(theta);\n\t\t\tvector.y = cos(theta);\n\t\t\tvector.z = -sin(phi) * sin(theta);\n\n\t\t\tvector = normalize(vector);\n\t\t}\n\n\t\t// vector3 -> spherical -> uv\n\t\tvoid vector3ToUV(in vec3 vector, out vec2 uv) {\n\t\t\tfloat theta = acos(vector.y);\n\t\t\tfloat phi = atan(vector.z, vector.x);\n\t\t\tuv.x = phi / 2.0 / PI;\n\t\t\tuv.y = theta / PI;\n\t\t}\n\n\t\tvec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {\n\t\t\treturn normalize((vec4(dir, 0.0) * matrix).xyz);\n\t\t}\n\n\t\tvoid applyStretch(inout vec2 uv) {\n\t\t\tvec3 direction = vec3(0.0, 0.0, 0.0);\n\n\t\t\tuvToVector3(uv, direction);\n\n\t\t\tvec3 targetDirection = inverseTransformDirection(stretchDirection, u_Model);\n\t\t\tvec3 delta = direction - targetDirection;\n\t\t\tdirection += delta * stretchFactor;\n\t\t\tdirection = normalize(direction);\n\n\t\t\tvector3ToUV(direction, uv);\n\t\t}\n\n\t\t\t\tvoid main() {\n\t\t\tvec4 col = vec4(u_Color, u_Opacity);\n\n\t\t\t\t\t\tvec2 uv = v_Uv;\n\t\t\t\t\t\tuv.x = 1. - uv.x;\n\n\t\t\tapplyStretch(uv);\n\n\t\t\t\t\t\tcol.xyz *= texture2D(diffuseMap, fract(uv)).xyz;\n\n\t\t\t\t\t\tgl_FragColor = col;\n\t\t\t\t}\n\t\t"};class o{constructor(){this._link=null,this._duration=0,this._timer=0,this._running=!1,this._onUpdateCallback=null,this._onCompleteCallback=null}run(t,e={}){return this._link=t,this._duration=(void 0!==e.time?e.time:1e3)/1e3,this._timer=0,this._running=!0,this._resetProperties(),this}update(t){if(!this._running)return;this._timer+=t;let e=this._timer/this._duration;e=0===this._duration||e>1?1:e,this._updateProperties(e),this._onUpdateCallback&&this._onUpdateCallback(this._link,e),1===e&&(this._onCompleteCallback&&this._onCompleteCallback(this._link),this._running=!1)}stop(){return this._link=null,this._running=!1,this._timer=0,this}onUpdate(t){return this._onUpdateCallback=t,this}onComplete(t){return this._onCompleteCallback=t,this}_resetProperties(){}_updateProperties(t){}}t.FadeSwitcher=class extends o{constructor(){super()}_resetProperties(){const t=this._link;t.from.renderOrder=-999,t.to.renderOrder=-999.1,t.from.material.opacity=1,t.to.material.opacity=1,t.from.material.uniforms.stretchFactor=0,t.to.material.uniforms.stretchFactor=0}_updateProperties(t){this._link.from.material.opacity=1-t}},t.Pano=n,t.PanoCameraControls=class{constructor(t,n){this.object=t,this.object.euler.order="YXZ",this.domElement=void 0!==n?n:document,this.domElement.style.touchAction="none",n&&this.domElement.setAttribute("tabindex",-1),this.cameraFov=65/180*Math.PI,this.cameraAspect=null,this.dollyingSpeed=1,this.minFov=.25*Math.PI,this.maxFov=100/180*Math.PI,this.rotateSpeed=.25,this.enableRotateDamping=!0,this.rotateDampingFactor=.5,this.update=function(){m.add(l),this.object.euler.x-=m.x,this.object.euler.y-=m.y,this.object.euler.x=Math.min(.5*Math.PI,Math.max(.5*-Math.PI,this.object.euler.x)),this.enableRotateDamping?m.multiplyScalar(1-this.rotateDampingFactor):m.set(0,0),l.set(0,0);const t=this.domElement===document?this.domElement.body:this.domElement,e=null!==this.cameraAspect?this.cameraAspect:t.clientWidth/t.clientHeight;return this.cameraFov*=s,this.cameraFov>this.maxFov?this.cameraFov=this.maxFov:this.cameraFov<this.minFov&&(this.cameraFov=this.minFov),this.object.projectionMatrix.elements[0]=1/(e*Math.tan(this.cameraFov/2)),this.object.projectionMatrix.elements[5]=1/Math.tan(this.cameraFov/2),this.object.projectionMatrixInverse.getInverse(this.object.projectionMatrix),s=1,(8*(1-i.dot(this.object.quaternion))>o||Math.abs(r-this.cameraFov)>o)&&(i.copy(this.object.quaternion),r=this.cameraFov,!0)};const i=new e.Quaternion,o=1e-6;let r=0,s=1;const a=new e.Vector2,c=new e.Vector2,l=new e.Vector2,h=new e.Vector2,m=new e.Vector2,d=new e.Vector2,u=new e.Vector2,p=new e.Vector2,v=0,f=1,_=2,g=3;let y=v;const x=this,b=[],P={};function k(){const t=x.domElement===document?x.domElement.body:x.domElement,e=h.x,n=h.y;h.x=2*Math.PI*n/t.clientHeight,h.y=2*Math.PI*e/t.clientWidth}function E(){return Math.pow(.95,x.dollyingSpeed)}function F(t){s/=t}function w(t){let n=P[t.pointerId];void 0===n&&(n=new e.Vector2,P[t.pointerId]=n),n.set(t.pageX,t.pageY)}function M(t){delete P[t.pointerId];for(let e=0;e<b.length;e++)if(b[e].pointerId==t.pointerId)return void b.splice(e,1)}function I(t){const e=t.pointerId===b[0].pointerId?b[1]:b[0];return P[e.pointerId]}function D(t){"touch"===t.pointerType?function(t){switch(w(t),y){case _:if(1==b.length)c.set(t.pageX,t.pageY);else{const e=I(t),n=.5*(t.pageX+e.x),i=.5*(t.pageY+e.y);c.set(n,i)}h.subVectors(c,a).multiplyScalar(-x.rotateSpeed),k(),l.add(h),a.copy(c);break;case g:const e=I(t),n=t.pageX-e.x,i=t.pageY-e.y,o=Math.sqrt(n*n+i*i);u.set(0,o),p.set(0,Math.pow(u.y/d.y,x.dollyingSpeed)),F(p.y),d.copy(u);break;default:y=v}}(t):function(t){0!==y&&(c.set(t.clientX,t.clientY),h.subVectors(c,a).multiplyScalar(-x.rotateSpeed),k(),l.add(h),a.copy(c))}(t)}function C(t){M(t),0===b.length&&(x.domElement.releasePointerCapture(t.pointerId),x.domElement.removeEventListener("pointermove",D),x.domElement.removeEventListener("pointerup",C)),y=v,"mouse"===t.pointerType&&(x.domElement.style.cursor=""),h.set(0,0)}this.domElement.addEventListener("pointerdown",(function(t){0===b.length&&(x.domElement.setPointerCapture(t.pointerId),x.domElement.addEventListener("pointermove",D),x.domElement.addEventListener("pointerup",C)),b.push(t),"touch"===t.pointerType?function(t){switch(w(t),b.length){case 1:if(1===b.length)a.set(b[0].pageX,b[0].pageY);else{const t=.5*(b[0].pageX+b[1].pageX),e=.5*(b[0].pageY+b[1].pageY);a.set(t,e)}y=_;break;case 2:const t=b[0].pageX-b[1].pageX,e=b[0].pageY-b[1].pageY,n=Math.sqrt(t*t+e*e);d.set(0,n),y=g;break;default:y=v}}(t):function(t){0===t.button&&(x.domElement.style.cursor="move",a.set(t.clientX,t.clientY),y=f)}(t)})),this.domElement.addEventListener("mouseleave",(function(t){y&&(M(t),x.domElement.style.cursor="",y=v,h.set(0,0))})),this.domElement.addEventListener("pointercancel",(function(t){M(t)})),this.domElement.addEventListener("wheel",(function(t){var e;t.preventDefault(),t.deltaY<0?(e=E(),s*=e):t.deltaY>0&&F(E())}),{passive:!1}),k()}},t.PanoGraph=class{constructor(){this.links=[]}link(t,e,n){for(let n=0;n<this.links.length;n++){const i=this.links[n];if(i.from===t&&i.to===e)return console.warn("PanoGraph: Duplicate pano Links."),this}return this.links.push({from:t,to:e,direction:n}),this}delink(t,e){for(let n=0;n<this.links.length;n++)if(this.links[n].from===t&&this.links[n].to===e)return this.links.splice(n,1),this;return this}getLinks(t,e=[]){return e.length=0,this.links.forEach((n=>{n.from===t&&e.push(n)})),e}},t.PanoSwitcher=o,t.StretchSwitcher=class extends o{constructor(){super()}_resetProperties(){const t=this._link;t.from.renderOrder=-999,t.to.renderOrder=-999.1,t.from.material.opacity=1,t.to.material.opacity=1,t.from.material.uniforms.stretchFactor=0,t.to.material.uniforms.stretchFactor=0,t.from.material.uniforms.stretchDirection[0]=t.direction[0],t.from.material.uniforms.stretchDirection[1]=t.direction[1],t.from.material.uniforms.stretchDirection[2]=t.direction[2],t.to.material.uniforms.stretchDirection[0]=-t.direction[0],t.to.material.uniforms.stretchDirection[1]=-t.direction[1],t.to.material.uniforms.stretchDirection[2]=-t.direction[2]}_updateProperties(t){const e=this._link;e.from.material.opacity=-(1-t)*(1-t)+2*(1-t),e.from.material.uniforms.stretchFactor=.7*t,e.to.material.uniforms.stretchFactor=.5*(1-t)}}}));
